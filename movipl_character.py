# -*- coding: utf-8 -*-
"""MoviPL-Character

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1e4NajIJM06eJ5oSxO_ESeTcAdDIC2KX_
"""

# ===================================================================
# âš™ï¸ 1. í™˜ê²½ ì„¤ì • ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
# ===================================================================
# í”„ë¡œì íŠ¸ì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
!pip install requests spotipy openai

# ===================================================================
# ğŸ”‘ 2. API Key ë³´ì•ˆ ê´€ë¦¬
# ===================================================================
# [ì¤‘ìš”!] ì½”ë© ì¢Œì¸¡ì˜ ì—´ì‡ (ğŸ”‘) ì•„ì´ì½˜ì„ ëˆŒëŸ¬ ì•„ë˜ ì´ë¦„ìœ¼ë¡œ Keyë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.
# - TMDB_API_KEY, OPENAI_API_KEY, SPOTIFY_CLIENT_ID,
# - SPOTIFY_CLIENT_SECRET, SPOTIFY_REDIRECT_URI
# ===================================================================

# --- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ë³´ì•ˆ ë¹„ë°€ ê°€ì ¸ì˜¤ê¸° ---
from google.colab import userdata
import spotipy
from spotipy.oauth2 import SpotifyOAuth
import requests
import openai
import json
import os
import re

class MoviPL_Character:
    """
    ì˜í™” ì† íŠ¹ì • 'ë“±ì¥ì¸ë¬¼'ì˜ ë‚´ë©´ì„ ë¶„ì„í•˜ì—¬,
    ê·¸ë¥¼ ìœ„í•œ ê°œì¸í™”ëœ ì‚¬ìš´ë“œíŠ¸ë™ê³¼ 'ì¶”ì²œ ì´ìœ 'ê¹Œì§€ ìƒì„±í•˜ëŠ” MoviPL ì—”ì§„ í´ë˜ìŠ¤.
    """
    def __init__(self):
        self.tmdb_api_key = None
        self.sp = None
        self.is_ready = False
        self._setup_keys()
        if self.tmdb_api_key and openai.api_key:
            self.sp = self._get_spotify_client()
            if self.sp:
                self.is_ready = True

    def _setup_keys(self):
        try:
            self.tmdb_api_key = userdata.get('TMDB_API_KEY')
            openai.api_key = userdata.get('OPENAI_API_KEY')
            print("âœ… TMDB ë° OpenAI API Key ë¡œë”© ì„±ê³µ!")
        except Exception as e:
            print(f"âŒ API Key ë¡œë”© ì‹¤íŒ¨. ì½”ë© 'ë³´ì•ˆ ë¹„ë°€' ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ì˜¤ë¥˜: {e}")

    def _get_spotify_client(self):
        try:
            client_id = userdata.get('SPOTIFY_CLIENT_ID')
            client_secret = userdata.get('SPOTIFY_CLIENT_SECRET')
            redirect_uri = userdata.get('SPOTIFY_REDIRECT_URI')
            auth_manager = SpotifyOAuth(client_id=client_id, client_secret=client_secret, redirect_uri=redirect_uri, scope="", open_browser=False)
            auth_url = auth_manager.get_authorize_url()
            print("\n--- Spotify ìˆ˜ë™ ì¸ì¦ ì ˆì°¨ ---")
            print("1. ì•„ë˜ URLì— ì ‘ì†í•˜ì—¬ ê¶Œí•œì— ë™ì˜í•˜ì„¸ìš”.")
            print(f"ì¸ì¦ URL: {auth_url}")
            print("\n2. ê¶Œí•œ ë™ì˜ í›„ 'ì—°ê²°í•  ìˆ˜ ì—†ìŒ' í˜ì´ì§€ì˜ ì „ì²´ URLì„ ë³µì‚¬í•˜ì—¬ ì•„ë˜ì— ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.")
            redirected_url = input("ë¦¬ë””ë ‰ì…˜ëœ URLì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”: ")
            code = auth_manager.parse_response_code(redirected_url)
            token_info = auth_manager.get_access_token(code, as_dict=False)
            sp = spotipy.Spotify(auth=token_info)
            print("\nâœ… Spotify ì¸ì¦ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!")
            return sp
        except Exception as e:
            print(f"\nâŒ Spotify ì¸ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: {e}")
            return None

    def _get_movie_and_character_data(self, movie_title):
        """TMDBì—ì„œ ì˜í™” ì •ë³´ì™€ ì£¼ìš” ë“±ì¥ì¸ë¬¼ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤."""
        print(f"\n--- 1. TMDBì—ì„œ '{movie_title}' ì˜í™” ì •ë³´ ê²€ìƒ‰ ---")
        search_url = f"https://api.themoviedb.org/3/search/movie?api_key={self.tmdb_api_key}&query={movie_title}&language=ko-KR"
        try:
            response = requests.get(search_url)
            response.raise_for_status()
            search_results = response.json().get('results')
            if not search_results:
                print(f"-> ì˜¤ë¥˜: '{movie_title}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.")
                return None, None

            movie = search_results[0]
            movie_id = movie['id']
            overview = movie.get('overview')

            credits_url = f"https://api.themoviedb.org/3/movie/{movie_id}/credits?api_key={self.tmdb_api_key}&language=ko-KR"
            credits_response = requests.get(credits_url)
            credits_response.raise_for_status()
            cast = credits_response.json().get('cast', [])

            characters = [member['character'] for member in cast[:5] if member['character']]

            print(f"-> ì˜í™” ê²€ìƒ‰ ì™„ë£Œ!")
            return overview, characters
        except requests.exceptions.RequestException as e:
            print(f"-> TMDB API ì˜¤ë¥˜: {e}")
            return None, None

    def _get_character_keywords_from_llm(self, overview, character_name):
        """LLMì„ í†µí•´ íŠ¹ì • ë“±ì¥ì¸ë¬¼ì˜ ë‚´ë©´ì„ ë¶„ì„í•˜ê³  ìŒì•…ì  í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤."""
        print(f"--- 2. LLM(ìºë¦­í„° ë¶„ì„ê°€)ìœ¼ë¡œ '{character_name}'ì˜ ë‚´ë©´ ë¶„ì„ ---")
        if not overview: return []

        prompt = f"""
        ë‹¹ì‹ ì€ ì‹¬ë¦¬í•™ìì´ì ìºë¦­í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        ì•„ë˜ ì˜í™” ì¤„ê±°ë¦¬ì—ì„œ '{character_name}'ì´ë¼ëŠ” ì¸ë¬¼ì— ëŒ€í•´ ì‹¬ì¸µì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.
        ê·¸ì˜ ì„±ê²©, ë™ê¸°, ë‚´ì  ê°ˆë“±, ê·¸ë¦¬ê³  ê°ì •ì˜ ë³€í™”ë¥¼ ì¢…í•©í•˜ì—¬,
        ê·¸ì˜ ë‚´ë©´ì„ ê°€ì¥ ì˜ ë‚˜íƒ€ë‚´ëŠ” ìŒì•…ì  í‚¤ì›Œë“œ 5ê°œë¥¼ JSON ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

        - ì˜í™” ì¤„ê±°ë¦¬: {overview}
        """
        try:
            response = openai.chat.completions.create(
                model="gpt-3.5-turbo-1106",
                messages=[
                    {"role": "system", "content": "You are a psychologist and character analyst who translates a character's inner world into musical keywords."},
                    {"role": "user", "content": prompt}
                ],
                response_format={"type": "json_object"}
            )
            result_text = response.choices[0].message.content
            keywords = list(json.loads(result_text).values())[0]
            print(f"-> ì¶”ì¶œëœ '{character_name}'ì˜ ë‚´ë©´ í‚¤ì›Œë“œ: {keywords}")
            return keywords
        except Exception as e:
            print(f"-> OpenAI API ì˜¤ë¥˜: {e}")
            return []

    def _recommend_music(self, keywords):
        """ì¶”ì¶œëœ í‚¤ì›Œë“œë¡œ Spotifyì—ì„œ ìŒì•…ì„ ê²€ìƒ‰í•˜ê³  ì¤‘ë³µì„ ì œê±°í•˜ì—¬ ì¶”ì²œí•©ë‹ˆë‹¤."""
        print("--- 3. í‚¤ì›Œë“œë¡œ Spotify ìŒì•… ì¶”ì²œ ---")
        if not keywords: return []
        try:
            query = " ".join(keywords)
            results = self.sp.search(q=query, type='track', limit=20, market="KR")
            unique_tracks, seen_normalized_titles = [], set()
            for track in results.get('tracks', {}).get('items', []):
                title = track.get('name')
                normalized_title = re.split(r'\(|-', title)[0].strip().lower()
                if normalized_title in seen_normalized_titles: continue
                unique_tracks.append(track)
                seen_normalized_titles.add(normalized_title)
                if len(unique_tracks) >= 5: break
            return unique_tracks
        except Exception as e:
            print(f"-> Spotify API ì˜¤ë¥˜: {e}")
            return []

    def _get_character_recommendation_reason(self, movie_title, character_name, track_title, artist_name):
        """LLMì„ í†µí•´ ìºë¦­í„°ì˜ ë‚´ë©´ê³¼ ì¶”ì²œê³¡ì´ ì™œ ì–´ìš¸ë¦¬ëŠ”ì§€ ì´ìœ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
        prompt = f"""
        ë‹¹ì‹ ì€ ìºë¦­í„°ì˜ ì‹¬ë¦¬ë¥¼ ìŒì•…ìœ¼ë¡œ í•´ì„í•˜ëŠ” 'ìŒì•… í‰ë¡ ê°€'ì…ë‹ˆë‹¤.
        ì˜í™” <{movie_title}>ì˜ ë“±ì¥ì¸ë¬¼ '{character_name}'ì˜ ë‚´ë©´ê³¼,
        ì•„í‹°ìŠ¤íŠ¸ '{artist_name}'ì˜ ë…¸ë˜ <{track_title}>ì´(ê°€) ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ”ì§€,
        ê·¸ ì´ìœ ë¥¼ ê°ì„±ì ì¸ í•œ ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”.
        """
        try:
            response = openai.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": "You are a music critic who explains the connection between a character's psychology and music."},
                    {"role": "user", "content": prompt}
                ]
            )
            reason = response.choices[0].message.content
            return reason
        except Exception as e:
            print(f"-> ì¶”ì²œ ì´ìœ  ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")
            return "ì¶”ì²œ ì´ìœ ë¥¼ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."

    def run(self):
        """ì‚¬ìš©ìì™€ ìƒí˜¸ì‘ìš©í•˜ë©° ë“±ì¥ì¸ë¬¼ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
        movie_title = input("\ní”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê³  ì‹¶ì€ ì˜í™” ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”: ")
        if not movie_title:
            print("-> ì˜í™” ì œëª©ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            return

        overview, characters = self._get_movie_and_character_data(movie_title)
        if not overview or not characters:
            return

        print("\n--- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê³  ì‹¶ì€ ì¸ë¬¼ì„ ì„ íƒí•´ì£¼ì„¸ìš” ---")
        for i, name in enumerate(characters):
            print(f"  {i+1}. {name}")

        try:
            choice = int(input("ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”: ")) - 1
            if not (0 <= choice < len(characters)):
                print("-> ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤. ì²« ë²ˆì§¸ ì¸ë¬¼ì„ ì„ íƒí•©ë‹ˆë‹¤.")
                choice = 0
            selected_character = characters[choice]
        except (ValueError, IndexError):
            print("-> ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤. ì²« ë²ˆì§¸ ì¸ë¬¼ì„ ì„ íƒí•©ë‹ˆë‹¤.")
            selected_character = characters[0]

        keywords = self._get_character_keywords_from_llm(overview, selected_character)
        if not keywords:
            print("-> í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í•´ ì¶”ì²œì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
            return

        recommended_tracks = self._recommend_music(keywords)

        print(f"\nâœ¨ '{selected_character}'ì˜ ë‚´ë©´ ì‚¬ìš´ë“œíŠ¸ë™ âœ¨")
        if not recommended_tracks:
            print("-> ì¶”ì²œí•  ë§Œí•œ ê³¡ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
            return

        for i, track in enumerate(recommended_tracks):
            title = track.get('name')
            artist = ", ".join([a['name'] for a in track.get('artists', [])])
            print(f"\nğŸµ {i+1}. {title} - {artist}")

            reason = self._get_character_recommendation_reason(movie_title, selected_character, title, artist)
            print(f"   - ì¶”ì²œ ì´ìœ : {reason}")

# --- ë©”ì¸ ì‹¤í–‰ ë¶€ë¶„ ---
if __name__ == "__main__":
    movipl_engine = MoviPL_Character()
    if movipl_engine.is_ready:
        movipl_engine.run()